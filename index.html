<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>瑋志自製小工具</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600&display=swap');
        body {
            font-family: 'Inter', sans-serif;
            margin: 0;
            padding: 0;
            background-color: #f3f4f6;
        }
        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 1rem;
        }
        .tab-button {
            padding: 0.75rem 1.5rem;
            font-weight: 600;
            border-radius: 9999px;
            cursor: pointer;
            transition: all 0.2s ease-in-out;
            border: 1px solid transparent;
        }
        .tab-button.active {
            background-color: #e5e7eb;
            color: #1f2937;
            border-color: #d1d5db;
        }
        .tab-button:not(.active):hover {
            background-color: #f3f4f6;
        }
        .tab-content {
            display: none;
        }
        .tab-content.active {
            display: block;
        }
        .tower-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(130px, 1fr));
            gap: 1.5rem;
        }
        .tower-item {
            display: flex;
            flex-direction: column;
            padding: 1rem;
            border-radius: 8px;
            border: 1px solid #d1d5db;
            background-color: #ffffff;
            font-weight: 500;
        }
        .layer-list {
            display: flex;
            flex-direction: column;
            gap: 0.5rem;
            margin-top: 1rem;
        }
        .layer-item {
            display: flex;
            align-items: center;
            justify-content: space-between;
            border-radius: 6px;
            padding: 0.5rem;
            border: 1px solid #e5e7eb;
            text-align: left;
            font-size: 0.75rem;
            transition: all 0.2s ease-in-out;
        }
        .layer-item.sold {
            background-color: #fca5a5;
            border-color: #f87171;
        }
        .layer-item.unsold {
            background-color: #a7f3d0;
            border-color: #6ee7b7;
        }
        .hidden {
            display: none !important;
        }
        .filter-button {
            padding: 0.5rem 1rem;
            border-radius: 9999px;
            font-weight: 500;
            background-color: #f3f4f6;
            border: 1px solid #d1d5db;
            cursor: pointer;
            transition: all 0.2s ease-in-out;
        }
        .filter-button:hover {
            background-color: #e5e7eb;
        }
        .filter-button.active {
            background-color: #d1d5db;
        }

        @media print {
            @page {
                size: A4 portrait;
                margin: 0.7in;
            }
            body {
                background-color: #fff;
                color: #000;
                margin: 0;
                padding: 0;
                overflow: visible !important;
                display: block;
            }
            .container {
                width: 100%;
                padding: 0;
                margin: 0;
                max-width: none;
            }
            .no-print {
                display: none !important;
            }
            #inventory-tab-content, #status-tab-content {
                display: block !important;
            }
            #stats-tab-content {
                display: none !important;
            }
            .tower-grid {
                grid-template-columns: repeat(5, 1fr);
                gap: 0.5rem;
                width: 100%;
            }
            .tower-item {
                box-shadow: none;
                transform: none;
                padding: 0.3rem;
                font-size: 0.7rem;
                border: 1px solid #d1d5db !important;
                height: auto;
                min-width: 100px;
                page-break-inside: avoid;
            }
            .layer-list {
                gap: 0.2rem;
                margin-top: 0.4rem;
            }
            .layer-item {
                font-size: 0.65rem;
                padding: 0.2rem;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <header class="no-print text-center mb-4">
            <h1 class="text-xl font-bold text-gray-800 mb-1">瑋志自製小工具</h1>
            <p class="text-gray-600 text-sm">請上傳您的塔位資料 CSV 檔案以進行查詢。</p>
            <div class="mt-4 flex flex-col items-center space-y-2">
                <input type="file" id="csvFile" accept=".csv, .xls, .xlsx" class="block w-full text-sm text-gray-500
                    file:mr-4 file:py-2 file:px-4
                    file:rounded-full file:border-0
                    file:text-sm file:font-semibold
                    file:bg-blue-50 file:text-blue-700
                    hover:file:bg-blue-100 transition duration-200
                "/>
                <div class="mt-2 flex items-center space-x-2">
                    <label for="encodingSelect" class="text-sm font-semibold text-gray-700">編碼:</label>
                    <select id="encodingSelect" class="rounded-md border border-gray-300 bg-white py-1 px-2 text-sm text-gray-800">
                        <option value="UTF-8">UTF-8</option>
                        <option value="Big5" selected>Big5</option>
                        <option value="windows-1252">Windows-1252</option>
                    </select>
                </div>
            </div>
            <p id="file-error" class="mt-2 text-sm text-red-500 hidden">檔案讀取失敗，請確認檔案格式是否正確。</p>
        </header>

        <div id="tabs-container" class="no-print mt-8 hidden">
            <div class="flex justify-center mb-4 space-x-4">
                <button id="inventory-tab" class="tab-button active">塔位銷售查詢</button>
                <button id="status-tab" class="tab-button">塔位銷售狀態</button>
                <button id="stats-tab" class="tab-button">銷售統計</button>
            </div>
            
            <div id="inventory-tab-content" class="tab-content active p-6 bg-white rounded-lg shadow-md">
                <h2 class="text-lg font-semibold text-gray-800 mb-4">塔位查詢</h2>
                <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                    <div>
                        <label for="layerInput" class="block text-sm font-medium text-gray-700">樓層:</label>
                        <input type="text" id="layerInput" placeholder="例如: 02" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring focus:ring-blue-500 focus:ring-opacity-50">
                    </div>
                    <div>
                        <label for="areaInput" class="block text-sm font-medium text-gray-700">區域:</label>
                        <input type="text" id="areaInput" placeholder="例如: A" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring focus:ring-blue-500 focus:ring-opacity-50">
                    </div>
                    <div>
                        <label for="numberInput" class="block text-sm font-medium text-gray-700">號:</label>
                        <input type="text" id="numberInput" placeholder="例如: 001" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring focus:ring-blue-500 focus:ring-opacity-50">
                    </div>
                </div>
                <div class="flex justify-center space-x-4 mt-6">
                    <button id="searchButton" class="px-6 py-2 bg-blue-600 text-white font-semibold rounded-lg shadow-md hover:bg-blue-700 transition duration-200">
                        搜尋
                    </button>
                    <button onclick="window.print()" class="px-6 py-2 bg-gray-200 text-gray-800 font-semibold rounded-lg shadow-md hover:bg-gray-300 transition duration-200">
                        列印
                    </button>
                </div>
            </div>

            <div id="stats-tab-content" class="tab-content p-6 bg-white rounded-lg shadow-md">
                <h2 class="text-lg font-semibold text-gray-800 mb-4">銷售統計</h2>
                <p id="stats-instruction" class="text-gray-600 text-sm mb-4">請點擊下方樓層按鈕以顯示銷售統計資料，可複選。</p>
                <div id="stats-buttons" class="flex flex-wrap gap-2 mb-4">
                    <!-- Buttons will be generated here -->
                </div>
                <div id="statsList" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
                    <!-- Statistics will be generated here -->
                </div>
                <div id="totalStats" class="mt-6 pt-4 border-t border-gray-200 hidden">
                    <h3 class="text-base font-semibold text-gray-800 mb-2">總計:</h3>
                    <div class="flex justify-between font-bold text-sm">
                        <span class="text-red-500">已售總計: <span id="totalSold">0</span> 個</span>
                        <span class="text-green-600">未售總計: <span id="totalUnsold">0</span> 個</span>
                    </div>
                </div>
            </div>

            <div id="status-tab-content" class="tab-content p-6 bg-white rounded-lg shadow-md">
                <h2 class="text-lg font-semibold text-gray-800 mb-4">塔位銷售狀態</h2>
                <p id="status-instruction" class="text-gray-600 text-sm mb-4">請點擊下方按鈕以顯示塔位資料。</p>
                <div id="status-buttons" class="flex flex-wrap gap-2 mb-4">
                    <!-- Buttons will be generated here -->
                </div>
            </div>
        </div>

        <div id="loading" class="no-print text-center text-gray-500 mt-8 hidden">
            <div class="animate-spin inline-block w-8 h-8 border-[3px] border-current border-t-transparent text-blue-600 rounded-full" role="status">
                <span class="!absolute !-m-px !h-px !w-px !overflow-hidden !whitespace-nowrap !border-0 !p-0 ![clip:rect(0,0,0,0)]">Loading...</span>
            </div>
            <p class="mt-2">正在讀取檔案，請稍候...</p>
        </div>

        <div id="towerList" class="tower-grid mt-8">
            <!-- Content for tower list will be rendered here -->
        </div>
    </div>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.3.0/papaparse.min.js"></script>
    <script>
        document.addEventListener('DOMContentLoaded', () => {
            const towerListContainer = document.getElementById('towerList');
            const csvFileInput = document.getElementById('csvFile');
            const encodingSelect = document.getElementById('encodingSelect');
            const loadingIndicator = document.getElementById('loading');
            const fileError = document.getElementById('file-error');
            const tabsContainer = document.getElementById('tabs-container');
            const statsList = document.getElementById('statsList');
            const searchButton = document.getElementById('searchButton');
            const layerInput = document.getElementById('layerInput');
            const areaInput = document.getElementById('areaInput');
            const numberInput = document.getElementById('numberInput');
            
            const inventoryTabBtn = document.getElementById('inventory-tab');
            const statusTabBtn = document.getElementById('status-tab');
            const statsTabBtn = document.getElementById('stats-tab');
            const inventoryTabContent = document.getElementById('inventory-tab-content');
            const statusTabContent = document.getElementById('status-tab-content');
            const statsTabContent = document.getElementById('stats-tab-content');
            const statusButtonsContainer = document.getElementById('status-buttons');
            const statsButtonsContainer = document.getElementById('stats-buttons');
            const totalStatsContainer = document.getElementById('totalStats');
            const totalSoldSpan = document.getElementById('totalSold');
            const totalUnsoldSpan = document.getElementById('totalUnsold');
            
            let allTowerData = {};

            const switchTab = (tabName) => {
                // Remove active class from all buttons and content
                inventoryTabBtn.classList.remove('active');
                statusTabBtn.classList.remove('active');
                statsTabBtn.classList.remove('active');
                inventoryTabContent.classList.remove('active');
                statusTabContent.classList.remove('active');
                statsTabContent.classList.remove('active');
                
                // Clear the tower list and stats list when switching tabs
                towerListContainer.innerHTML = '';
                statsList.innerHTML = '';
                totalStatsContainer.classList.add('hidden');

                // Add active class to the selected tab and its content
                if (tabName === 'inventory') {
                    inventoryTabBtn.classList.add('active');
                    inventoryTabContent.classList.add('active');
                } else if (tabName === 'status') {
                    statusTabBtn.classList.add('active');
                    statusTabContent.classList.add('active');
                    // Reset button active state when switching to this tab
                    document.querySelectorAll('#status-buttons .filter-button').forEach(btn => btn.classList.remove('active'));
                } else { // stats tab
                    statsTabBtn.classList.add('active');
                    statsTabContent.classList.add('active');
                     // Reset button active state when switching to this tab
                    document.querySelectorAll('#stats-buttons .filter-button').forEach(btn => btn.classList.remove('active'));
                }
            };

            inventoryTabBtn.addEventListener('click', () => switchTab('inventory'));
            statusTabBtn.addEventListener('click', () => switchTab('status'));
            statsTabBtn.addEventListener('click', () => switchTab('stats'));

            const generateStats = (selectedLayers = []) => {
                statsList.innerHTML = '';
                totalStatsContainer.classList.add('hidden');
                let totalSold = 0;
                let totalUnsold = 0;

                if (selectedLayers.length === 0) {
                     statsList.innerHTML = '<p class="text-center text-gray-500">請點擊上方按鈕以顯示統計資料。</p>';
                     return;
                }

                const stats = {};
                selectedLayers.forEach(layer => {
                    if (allTowerData[layer]) {
                        if (!stats[layer]) {
                            stats[layer] = {};
                        }
                        for (const area in allTowerData[layer]) {
                            if (!stats[layer][area]) {
                                stats[layer][area] = { sold: 0, unsold: 0 };
                            }
                            
                            for (const number in allTowerData[layer][area]) {
                                for (const tier in allTowerData[layer][area][number]) {
                                    const salesStatus = allTowerData[layer][area][number][tier];
                                    if (salesStatus === '已售') {
                                        stats[layer][area].sold++;
                                        totalSold++;
                                    } else {
                                        stats[layer][area].unsold++;
                                        totalUnsold++;
                                    }
                                }
                            }
                        }
                    }
                });
                
                renderStats(stats, totalSold, totalUnsold);
            };

            const renderStats = (stats, totalSold, totalUnsold) => {
                statsList.innerHTML = '';
                const sortedLayers = Object.keys(stats).sort();

                if (sortedLayers.length === 0) {
                    statsList.innerHTML = '<p class="text-center text-gray-500">沒有找到任何統計資料。</p>';
                    return;
                }

                sortedLayers.forEach(layer => {
                    const sortedAreas = Object.keys(stats[layer]).sort();
                    sortedAreas.forEach(area => {
                        const stat = stats[layer][area];
                        const statItem = document.createElement('div');
                        statItem.className = 'p-4 rounded-lg bg-gray-50 border border-gray-200';
                        statItem.innerHTML = `
                            <h3 class="font-bold text-gray-800 text-sm mb-1">樓層: ${layer}, 區域: ${area}</h3>
                            <p class="text-xs text-red-500 font-semibold">已售: ${stat.sold} 個</p>
                            <p class="text-xs text-green-600 font-semibold">未售: ${stat.unsold} 個</p>
                        `;
                        statsList.appendChild(statItem);
                    });
                });

                // Update total stats and show the container
                totalSoldSpan.textContent = totalSold;
                totalUnsoldSpan.textContent = totalUnsold;
                totalStatsContainer.classList.remove('hidden');
            };

            const renderTowerList = (groupedData) => {
                towerListContainer.innerHTML = '';
                if (Object.keys(groupedData).length === 0) {
                    towerListContainer.innerHTML = '<p class="text-center text-gray-500 mt-8">沒有找到相關的塔位資料。</p>';
                    return;
                }

                const sortedTowerIds = Object.keys(groupedData).sort();

                sortedTowerIds.forEach(towerId => {
                    const towerItemDiv = document.createElement('div');
                    towerItemDiv.className = `tower-item rounded-lg shadow-sm`;
                    
                    const layerListDiv = document.createElement('div');
                    layerListDiv.className = `layer-list`;
                    
                    const sortedTiers = Object.keys(groupedData[towerId]).sort((a, b) => {
                        return parseInt(a, 10) - parseInt(b, 10);
                    });

                    sortedTiers.forEach(tier => {
                        const salesStatus = groupedData[towerId][tier];
                        const layerItemDiv = document.createElement('div');
                        layerItemDiv.className = `layer-item ${salesStatus === '已售' ? 'sold' : 'unsold'}`;
                        layerItemDiv.innerHTML = `
                            <span class="font-bold">${tier}層</span>
                            <span class="status">${salesStatus}</span>
                        `;
                        layerListDiv.appendChild(layerItemDiv);
                    });

                    towerItemDiv.innerHTML = `
                        <h3 class="font-bold text-base text-gray-800 text-center">${towerId}</h3>
                    `;
                    towerItemDiv.appendChild(layerListDiv);
                    towerListContainer.appendChild(towerItemDiv);
                });
            };

            const createStatusButtons = () => {
                statusButtonsContainer.innerHTML = '';
                const allButton = document.createElement('button');
                allButton.textContent = '全部顯示';
                allButton.className = 'filter-button';
                allButton.addEventListener('click', () => {
                    renderAllTowers();
                    document.querySelectorAll('#status-buttons .filter-button').forEach(btn => btn.classList.remove('active'));
                    allButton.classList.add('active');
                });
                statusButtonsContainer.appendChild(allButton);

                const sortedLayers = Object.keys(allTowerData).sort();
                sortedLayers.forEach(layer => {
                    const layerButton = document.createElement('button');
                    layerButton.textContent = `樓層 ${layer}`;
                    layerButton.className = 'filter-button';
                    layerButton.addEventListener('click', () => {
                        renderTowersByLayer(layer);
                        document.querySelectorAll('#status-buttons .filter-button').forEach(btn => btn.classList.remove('active'));
                        layerButton.classList.add('active');
                    });
                    statusButtonsContainer.appendChild(layerButton);
                });
            };

            const createStatsButtons = () => {
                statsButtonsContainer.innerHTML = '';
                const sortedLayers = Object.keys(allTowerData).sort();
                
                // Create individual layer buttons first
                sortedLayers.forEach(layer => {
                    const layerButton = document.createElement('button');
                    layerButton.textContent = `樓層 ${layer}`;
                    layerButton.className = 'filter-button';
                    layerButton.dataset.layer = layer;
                    layerButton.addEventListener('click', () => {
                        layerButton.classList.toggle('active');
                        // Deactivate "全部顯示" button if any layer button is clicked
                        const allStatsButton = document.getElementById('allStatsButton');
                        if (allStatsButton) {
                            allStatsButton.classList.remove('active');
                        }
                        const activeLayerButtons = document.querySelectorAll('#stats-buttons .filter-button.active[data-layer]');
                        const selectedLayers = Array.from(activeLayerButtons).map(btn => btn.dataset.layer);
                        generateStats(selectedLayers);
                    });
                    statsButtonsContainer.appendChild(layerButton);
                });
                
                // Create "Show All" button at the end
                const allButton = document.createElement('button');
                allButton.textContent = '全部顯示';
                allButton.className = 'filter-button';
                allButton.id = 'allStatsButton';
                allButton.addEventListener('click', () => {
                    const isNowActive = allButton.classList.toggle('active');
                    const layerButtons = document.querySelectorAll('#stats-buttons .filter-button[data-layer]');
                    
                    if (isNowActive) {
                        // Activate all layer buttons and generate stats for all layers
                        layerButtons.forEach(btn => btn.classList.add('active'));
                        const selectedLayers = Object.keys(allTowerData).sort();
                        generateStats(selectedLayers);
                    } else {
                        // Deactivate all layer buttons and clear stats
                        layerButtons.forEach(btn => btn.classList.remove('active'));
                        generateStats([]); // Pass an empty array
                    }
                });
                statsButtonsContainer.appendChild(allButton);
            };

            const renderAllTowers = () => {
                const allData = {};
                for (const layer in allTowerData) {
                    for (const area in allTowerData[layer]) {
                        for (const number in allTowerData[layer][area]) {
                            const towerId = `${layer}-${area}-${number}`;
                            allData[towerId] = allTowerData[layer][area][number];
                        }
                    }
                }
                renderTowerList(allData);
            };

            const renderTowersByLayer = (selectedLayer) => {
                const filteredData = {};
                for (const layer in allTowerData) {
                    if (layer === selectedLayer) {
                        for (const area in allTowerData[layer]) {
                            for (const number in allTowerData[layer][area]) {
                                const towerId = `${layer}-${area}-${number}`;
                                filteredData[towerId] = allTowerData[layer][area][number];
                            }
                        }
                    }
                }
                renderTowerList(filteredData);
            };

            const parseFile = (file) => {
                loadingIndicator.classList.remove('hidden');
                towerListContainer.innerHTML = '';
                fileError.classList.add('hidden');
                tabsContainer.classList.add('hidden');
                statusButtonsContainer.innerHTML = ''; // Clear buttons on new file load
                statsButtonsContainer.innerHTML = '';
                statsList.innerHTML = '';
                totalStatsContainer.classList.add('hidden');

                const selectedEncoding = encodingSelect.value;
                
                Papa.parse(file, {
                    header: false,
                    skipEmptyLines: true,
                    encoding: selectedEncoding,
                    complete: function(results) {
                        loadingIndicator.classList.add('hidden');
                        if (results.data && results.data.length > 5) {
                            allTowerData = {};
                            const dataLines = results.data.slice(5);
                            
                            dataLines.forEach(row => {
                                // 塔位編號在欄位 B (索引 1)
                                const fullTowerId = row[1] ? row[1].trim() : '';
                                if (!fullTowerId) return;

                                const parts = fullTowerId.split('-');
                                if (parts.length < 4) return;
                                
                                const layer = parts[0].trim();
                                const area = parts[1].trim();
                                const number = parts[2].trim();
                                // 樓層號碼位於分割後的最後一個元素
                                const tier = parts[parts.length - 1].trim(); 
                                
                                // 銷售別在欄位 C (索引 2)
                                const salesStatus = row[2] ? row[2].trim() : '';

                                if (!allTowerData[layer]) {
                                    allTowerData[layer] = {};
                                }
                                if (!allTowerData[layer][area]) {
                                    allTowerData[layer][area] = {};
                                }
                                if (!allTowerData[layer][area][number]) {
                                    allTowerData[layer][area][number] = {};
                                }
                                
                                allTowerData[layer][area][number][tier] = salesStatus;
                            });

                            tabsContainer.classList.remove('hidden');
                            createStatusButtons();
                            createStatsButtons();
                            switchTab('inventory');
                        } else {
                            fileError.classList.remove('hidden');
                            towerListContainer.innerHTML = `<p class="text-center text-red-500 mt-8">檔案讀取失敗，請確認檔案格式是否正確。</p>`;
                        }
                    },
                    error: function(error) {
                        loadingIndicator.classList.add('hidden');
                        console.error('Error parsing CSV:', error);
                        fileError.classList.remove('hidden');
                        towerListContainer.innerHTML = `<p class="text-center text-red-500 mt-8">檔案讀取失敗，請確認檔案格式是否正確。</p>`;
                    }
                });
            };

            const performSearch = () => {
                const searchLayer = layerInput.value.trim();
                const searchArea = areaInput.value.trim().toUpperCase();
                const searchNumber = numberInput.value.trim();
                
                const filteredData = {};
                
                if (!searchLayer && !searchArea && !searchNumber) {
                    towerListContainer.innerHTML = '<p class="text-center text-gray-500 mt-8">請至少輸入一個查詢條件。</p>';
                    return;
                }

                for (const layer in allTowerData) {
                    if (searchLayer && layer !== searchLayer) continue;
                    
                    for (const area in allTowerData[layer]) {
                        if (searchArea && area !== searchArea) continue;

                        for (const number in allTowerData[layer][area]) {
                            if (searchNumber && number !== searchNumber) continue;
                            
                            const towerId = `${layer}-${area}-${number}`;
                            filteredData[towerId] = allTowerData[layer][area][number];
                        }
                    }
                }
                
                renderTowerList(filteredData);
            };

            csvFileInput.addEventListener('change', (event) => {
                const file = event.target.files[0];
                if (!file) return;
                parseFile(file);
            });
            
            encodingSelect.addEventListener('change', () => {
                const file = csvFileInput.files[0];
                if (file) {
                    parseFile(file);
                }
            });

            searchButton.addEventListener('click', performSearch);
        });
    </script>
</body>
</html>
